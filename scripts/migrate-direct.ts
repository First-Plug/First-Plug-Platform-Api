console.log('üî• SCRIPT DE MIGRACI√ìN DIRECTA INICIADO');
// por consola para migrar el tenant
//npm run migrate:direct retool

// Por consola para probar como quedaria el tenant migrado sin cambiarlo realmente en base de datos
// npm run migrate:direct retool --dry-run

import { MongoClient } from 'mongodb';

// Configuraci√≥n de conexi√≥n (usar la URI de MongoDB Atlas)
const MONGO_URI =
  process.env.DB_CONNECTION_STRING ||
  'mongodb+srv://santiago:2025devs%2B@firstplug-dev.qxiv5.mongodb.net/firstPlug';
console.log(
  `üîó URI de conexi√≥n: ${MONGO_URI.replace(/\/\/.*:.*@/, '//***:***@')}`,
);

interface MigrationResult {
  success: boolean;
  tenantName: string;
  message?: string;
  migratedUsers?: any[];
  createdOffice?: any;
  updatedTenant?: any;
  error?: string;
}

async function migrateTenantDirect(
  tenantName: string,
  dryRun: boolean = false,
): Promise<MigrationResult> {
  console.log(`üöÄ Iniciando migraci√≥n directa para tenant: ${tenantName}`);
  console.log(
    `üîí Modo: ${dryRun ? 'DRY RUN (solo lectura)' : 'EJECUCI√ìN REAL'}`,
  );

  const client = new MongoClient(MONGO_URI);

  try {
    // Conectar a MongoDB
    console.log('üì° Conectando a MongoDB...');
    await client.connect();
    console.log('‚úÖ Conectado a MongoDB');

    // Verificar qu√© bases de datos existen
    console.log('üîç Verificando bases de datos disponibles...');
    const adminDb = client.db().admin();
    const dbList = await adminDb.listDatabases();
    console.log('üìã Bases de datos disponibles:');
    dbList.databases.forEach((db) => {
      const sizeInMB = db.sizeOnDisk
        ? (db.sizeOnDisk / 1024 / 1024).toFixed(2)
        : 'N/A';
      console.log(`   - ${db.name} (${sizeInMB} MB)`);
    });

    // Obtener bases de datos (usar firstPlug de MongoDB Atlas)
    const mainDb = client.db('firstPlug');
    const tenantDb = client.db(`tenant_${tenantName}`);

    console.log(`üìã Usando bases de datos: firstPlug, tenant_${tenantName}`);

    // 1. Buscar usuarios viejos en la colecci√≥n tenants
    console.log(`üîç Buscando usuarios con tenantName: ${tenantName}`);
    const tenantsCollection = mainDb.collection('tenants');

    // Debug: Ver todas las colecciones y buscar el usuario
    console.log('üîç Verificando colecciones disponibles...');
    const collections = await mainDb.listCollections().toArray();
    console.log('üìã Colecciones en firstPlug:');
    collections.forEach((col) => {
      console.log(`   - ${col.name}`);
    });

    console.log('üîç Verificando estructura de colecci√≥n tenants...');
    const allTenants = await tenantsCollection.find({}).limit(3).toArray();
    console.log(
      `üìã Total documentos en tenants: ${await tenantsCollection.countDocuments()}`,
    );
    console.log('üìã Primeros 3 documentos en tenants:');
    allTenants.forEach((doc, index) => {
      console.log(`   ${index + 1}. ID: ${doc._id}`);
      console.log(`      tenantName: ${doc.tenantName || 'NO EXISTE'}`);
      console.log(`      name: ${doc.name || 'NO EXISTE'}`);
      console.log(`      email: ${doc.email || 'NO EXISTE'}`);
    });

    // Buscar el usuario espec√≠fico en todas las colecciones
    console.log(
      `üîç Buscando usuario mechi@email.com en todas las colecciones...`,
    );
    for (const col of collections) {
      const collection = mainDb.collection(col.name);
      const userInCol = await collection.findOne({ email: 'mechi@email.com' });
      if (userInCol) {
        console.log(`‚úÖ Usuario encontrado en colecci√≥n: ${col.name}`);
        console.log(`   - ID: ${userInCol._id}`);
        console.log(`   - tenantName: ${userInCol.tenantName || 'NO EXISTE'}`);
        console.log(`   - name: ${userInCol.name || 'NO EXISTE'}`);
        console.log(`   - email: ${userInCol.email}`);
      }
    }

    // üîß VERIFICAR SI YA EST√Å MIGRADO
    console.log('üîç Verificando si el tenant ya est√° migrado...');
    const usersCollection = mainDb.collection('users');
    const existingMigratedUser = await usersCollection.findOne({
      tenantName: tenantName,
    });

    if (existingMigratedUser) {
      console.log('‚ö†Ô∏è TENANT YA MIGRADO');
      console.log(`   - Usuario encontrado: ${existingMigratedUser.email}`);
      console.log('   - Use el script de rollback si necesita revertir');
      return {
        success: false,
        message: `Tenant ${tenantName} ya est√° migrado`,
        tenantName,
        error: 'Tenant already migrated',
      };
    }

    // üîß BUSCAR DOCUMENTOS DEL TENANT
    const oldUsers = await tenantsCollection.find({ tenantName }).toArray();

    // üîß FILTRAR SOLO DOCUMENTOS CON EMAIL V√ÅLIDO (usuarios reales)
    const validUsers = oldUsers.filter(
      (user) => user.email && user.email.trim() !== '',
    );
    console.log(
      `üîç Filtrados ${validUsers.length} usuarios v√°lidos de ${oldUsers.length} documentos`,
    );
    if (validUsers.length === 0) {
      // Intentar b√∫squeda alternativa
      console.log('üîç Intentando b√∫squeda alternativa...');
      const alternativeSearch = await tenantsCollection
        .find({
          $or: [
            { tenantName: tenantName },
            { name: { $regex: tenantName, $options: 'i' } },
            { email: { $regex: tenantName, $options: 'i' } },
          ],
        })
        .toArray();

      console.log(
        `üîç B√∫squeda alternativa encontr√≥: ${alternativeSearch.length} documentos`,
      );
      if (alternativeSearch.length > 0) {
        console.log('üìã Documentos encontrados en b√∫squeda alternativa:');
        alternativeSearch.forEach((doc) => {
          console.log(
            `   - ID: ${doc._id}, tenantName: ${doc.tenantName}, email: ${doc.email}`,
          );
        });
      }

      throw new Error(`No se encontraron usuarios para tenant: ${tenantName}`);
    }

    console.log(`üìã Encontrados ${validUsers.length} usuarios para migrar`);
    validUsers.forEach((user) => {
      console.log(`   - ${user.email} (${user.name})`);
    });

    // 2. Verificaci√≥n adicional por email (ya verificado arriba, pero por seguridad)
    const existingUser = await usersCollection.findOne({
      email: { $in: validUsers.map((u) => u.email) },
    });

    if (existingUser) {
      console.log('‚ö†Ô∏è Usuario espec√≠fico ya migrado:', existingUser.email);
      return {
        success: false,
        tenantName,
        error: `Usuario ya migrado: ${existingUser.email}`,
      };
    }

    // 3. Migrar usuarios a colecci√≥n users
    console.log(`üë• Migrando ${validUsers.length} usuarios...`);
    const migratedUsers: Array<{
      id: any;
      email: string;
      firstName: string;
    }> = [];

    // üîß CORRECCI√ìN: Identificar el tenant principal (el que se mantendr√°)
    const mainTenant = validUsers[0]; // El primer usuario ser√° el tenant principal
    console.log(
      `üè¢ Tenant principal identificado: ${mainTenant._id} (${mainTenant.email})`,
    );

    for (const oldUser of validUsers) {
      console.log(`üë§ Migrando usuario: ${oldUser.email}`);

      // üîß CORRECCI√ìN: Crear objeto base sin password/salt
      const newUser: any = {
        firstName: oldUser.name?.split(' ')[0] || 'Usuario',
        lastName: oldUser.name?.split(' ').slice(1).join(' ') || '',
        email: oldUser.email,
        accountProvider: oldUser.accountProvider || 'credentials',
        role: 'user', // ‚úÖ Agregar rol user
        tenantId: mainTenant._id, // üîß CORRECCI√ìN: ID del tenant principal, NO del usuario
        tenantName: oldUser.tenantName,
        widgets: oldUser.widgets || [],
        phone: '', // Datos personales vac√≠os
        address: '',
        apartment: '',
        city: '',
        state: '',
        country: '',
        zipCode: '',
        image: oldUser.image || '',
        status: 'active',
        isActive: true,
        isDeleted: false,
        createdAt: new Date(),
        updatedAt: new Date(),
      };

      // üîß CORRECCI√ìN: Solo agregar password/salt si usa credentials
      if (
        oldUser.accountProvider === 'credentials' ||
        !oldUser.accountProvider
      ) {
        newUser.password = oldUser.password;
        newUser.salt = oldUser.salt;
        console.log(
          `   - Usuario con credentials: password ${oldUser.password ? 'presente' : 'ausente'}`,
        );
      } else {
        console.log(
          `   - Usuario con ${oldUser.accountProvider}: sin password/salt`,
        );
      }

      if (dryRun) {
        console.log(`üîç [DRY RUN] Insertar√≠a usuario: ${newUser.email}`);
        // Simular ID para DRY RUN
        migratedUsers.push({
          id: 'dry-run-id',
          email: newUser.email,
          firstName: newUser.firstName,
        });
      } else {
        const result = await usersCollection.insertOne(newUser);
        migratedUsers.push({
          id: result.insertedId,
          email: newUser.email,
          firstName: newUser.firstName,
        });
      }

      console.log(`‚úÖ Usuario migrado: ${newUser.email}`);
    }

    // 4. Crear oficina en tenant DB (verificar si ya existe)
    const firstUser = validUsers[0]; // Usar primer usuario para datos de oficina
    const officesCollection = tenantDb.collection('offices');

    // Verificar si ya existe una oficina
    const existingOffice = await officesCollection.findOne({});
    if (existingOffice) {
      console.log('‚ö†Ô∏è Ya existe una oficina, saltando creaci√≥n');
    } else {
      console.log(`üè¢ Creando nueva oficina en tenant_${tenantName}...`);

      const newOffice = {
        name: 'Oficina Principal',
        email: '', // Vac√≠o inicialmente, se completar√° despu√©s
        phone: firstUser.phone || '',
        country: firstUser.country || '',
        city: firstUser.city || '',
        state: firstUser.state || '',
        zipCode: firstUser.zipCode || '',
        address: firstUser.address || '',
        apartment: firstUser.apartment || '',
        tenantId: mainTenant._id, // üîß CORRECCI√ìN: ID del tenant principal, NO del usuario
        isDefault: true,
        isActive: true,
        isDeleted: false,
        createdAt: new Date(),
        updatedAt: new Date(),
      };

      if (dryRun) {
        console.log(`üîç [DRY RUN] Crear√≠a oficina: ${newOffice.name}`);
      } else {
        await officesCollection.insertOne(newOffice);
        console.log(`‚úÖ Oficina creada: ${newOffice.name}`);
      }
    }

    // 5. Limpiar TODOS los tenants con el mismo tenantName
    console.log(`üßπ Limpiando ${validUsers.length} registros de tenant...`);
    const firstUserId = migratedUsers[0]?.id;

    // 5. Actualizar el tenant principal (ya identificado arriba)
    if (dryRun) {
      console.log(
        `üîç [DRY RUN] Actualizar√≠a tenant principal: ${mainTenant._id}`,
      );
    } else {
      await tenantsCollection.updateOne(
        { _id: mainTenant._id },
        {
          $unset: {
            // Remover datos de usuario
            email: 1,
            password: 1,
            salt: 1,
            accountProvider: 1,
            widgets: 1,
            // Remover datos de oficina
            phone: 1,
            country: 1,
            city: 1,
            state: 1,
            zipCode: 1,
            address: 1,
            apartment: 1,
          },
          $set: {
            // Actualizar datos corporativos
            name: `${tenantName.charAt(0).toUpperCase() + tenantName.slice(1)} Company`,
            createdBy: firstUserId,
            isActive: true,
            updatedAt: new Date(),
          },
        },
      );
    }

    // Eliminar los registros adicionales (usuarios duplicados)
    if (validUsers.length > 1) {
      const additionalIds = validUsers.slice(1).map((user) => user._id);
      console.log(
        `üóëÔ∏è Eliminando ${additionalIds.length} registros duplicados...`,
      );

      if (dryRun) {
        console.log(
          `üîç [DRY RUN] Eliminar√≠a ${additionalIds.length} registros duplicados`,
        );
      } else {
        await tenantsCollection.deleteMany({
          _id: { $in: additionalIds },
        });
        console.log(
          `‚úÖ ${additionalIds.length} registros duplicados eliminados`,
        );
      }
    }

    console.log(`‚úÖ Tenant principal limpiado`);

    return {
      success: true,
      tenantName,
      migratedUsers,
      createdOffice: {
        id: dryRun ? 'dry-run-office-id' : 'office-created',
        name: 'Oficina Principal',
        address: firstUser.address || '',
      },
      updatedTenant: {
        id: firstUser._id,
        name: `${firstUser.name} Company`,
      },
    };
  } catch (error) {
    console.error('‚ùå Error en migraci√≥n:', error.message);
    return {
      success: false,
      tenantName,
      error: error.message,
    };
  } finally {
    await client.close();
    console.log('üì° Conexi√≥n a MongoDB cerrada');
  }
}

// Script principal
async function main() {
  try {
    console.log('üöÄ INICIANDO MIGRACI√ìN DIRECTA');

    const tenantName = process.argv[2];
    const isDryRun =
      process.argv[3] === '--dry-run' || process.argv[3] === 'dry-run';

    // üîç DEBUG: Mostrar argumentos recibidos
    console.log('üîç DEBUG - Argumentos recibidos:', process.argv);
    console.log('üîç DEBUG - tenantName:', tenantName);
    console.log('üîç DEBUG - isDryRun:', isDryRun);
    console.log('üîç DEBUG - process.argv[3]:', process.argv[3]);

    if (!tenantName) {
      console.error('‚ùå Uso: npm run migrate:direct <tenantName> [--dry-run]');
      console.error('‚ùå Ejemplo: npm run migrate:direct mechi_test');
      console.error(
        '‚ùå Ejemplo DRY RUN: npm run migrate:direct mechi_test --dry-run',
      );
      process.exit(1);
    }

    console.log(`üéØ Migrando tenant: ${tenantName}`);
    if (isDryRun) {
      console.log(
        'üîç MODO DRY RUN ACTIVADO - Solo simulaci√≥n, no se har√°n cambios',
      );
    }

    const result = await migrateTenantDirect(tenantName, isDryRun);

    if (result.success) {
      console.log(`\nüéâ MIGRACI√ìN EXITOSA:`);
      console.log(`‚úÖ Tenant: ${result.tenantName}`);
      console.log(`‚úÖ Usuarios migrados: ${result.migratedUsers?.length || 0}`);
      result.migratedUsers?.forEach((user) => {
        console.log(`   - ${user.email} (${user.firstName})`);
      });
      console.log(`‚úÖ Oficina creada: ${result.createdOffice.name}`);
      console.log(`‚úÖ Tenant actualizado: ${result.updatedTenant.name}`);
    } else {
      console.log(`\nüí• MIGRACI√ìN FALL√ì:`);
      console.log(`‚ùå Tenant: ${result.tenantName}`);
      console.log(`‚ùå Error: ${result.error}`);
    }
  } catch (error) {
    console.error('üí• ERROR CR√çTICO:', error.message);
    process.exit(1);
  }
}

main().catch(console.error);
