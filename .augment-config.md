# Augment Agent - Configuraci√≥n del Proyecto FirstPlug

## üèóÔ∏è Arquitectura del Sistema

### **Patr√≥n de Servicios por Capas**

#### **Servicios Ra√≠z (Root Services)**

Interact√∫an directamente con la base de datos, manejan CRUD b√°sico:

- **`ProductsService`**: Gesti√≥n de productos en collections locales
- **`MembersService`**: Gesti√≥n de members y productos embebidos
- **`ShipmentsService`**: Gesti√≥n de shipments y logistics
- **`TenantsService`**: Gesti√≥n de tenants y configuraci√≥n
- **`WarehousesService`**: Gesti√≥n de warehouses y asignaciones

#### **Servicios Transversales (Cross-cutting Services)**

Coordinan entre servicios ra√≠z, manejan l√≥gica de negocio compleja:

- **`AssignmentsService`**: Movimiento de productos entre collections
- **`LogisticsService`**: Coordinaci√≥n de shipments y actualizaciones
- **`GlobalProductSyncService`**: Sincronizaci√≥n a collection global
- **`WarehouseAssignmentService`**: Asignaci√≥n inteligente de warehouses

#### **Servicios Helper**

L√≥gica de negocio espec√≠fica y reutilizable:

- **`LastAssignedHelper`**: C√°lculo de lastAssigned preservando ubicaciones
- **`SlackService`**: Notificaciones y alertas
- **`HistoryService`**: Tracking de cambios y auditor√≠a

#### **Servicios de Infraestructura**

- **`SuperAdminService`**: Operaciones cross-tenant, gesti√≥n global
- **`AuthService`**: Autenticaci√≥n y autorizaci√≥n
- **`ConfigService`**: Configuraci√≥n de aplicaci√≥n
- **`TenantModelRegistry`**: Registry de modelos por tenant (CLAVE)
- **`TenantConnectionService`**: Gesti√≥n de conexiones multi-tenant

#### **Servicios Comunes**

- **`CommonService`**: Utilidades compartidas
- **`ValidationService`**: Validaciones reutilizables
- **`InfraService`**: Servicios de infraestructura base

---

## üè¢ Multi-Tenant Architecture

### **Estructura de Base de Datos**

- **Tenant Database**: `tenant_{tenantName}` (ej: `tenant_mechi_test`)
  - Collections: `products`, `members`, `shipments`, `offices`, `teams`, `historial`, `shipmentsMetadata`
- **Global Database**: `firstPlug`
  - Collections: `tenants`, `users`, `global_products`, `warehouses`

### **Roles y Permisos**

- **SuperAdmin**: Acceso a todos los tenants, puede crear/modificar cualquier dato
- **Tenant User**: Solo acceso a su tenant espec√≠fico
- **admin**: Solo acceso a su tenant espec√≠fico

### **Tenant Resolution**

```typescript
// Siempre resolver tenant por tenantName
const connection = await this.connectionService.getTenantConnection(tenantName);
const ProductModel = connection.model('Product', ProductSchema);
```

---

## üì¶ Ubicaciones de Productos

### **Ubicaciones V√°lidas**

- **`"Employee"`**: Producto asignado a un member (en `members` collection)
- **`"FP warehouse"`**: Producto en warehouse de FirstPlug (en `products` collection)
- **`"Our office"`**: Producto en oficina del tenant (en `products` collection)

### **Collections por Ubicaci√≥n**

- **Employee** ‚Üí `members.products[]` (embebido)
- **FP warehouse** ‚Üí `products` collection + `fpWarehouse` data
- **Our office** ‚Üí `products` collection + office data

---

## ÔøΩ Estados de Productos (SAGRADO)

### **Regla Fundamental: Estado = f(Location, Shipment)**

#### **Sin Shipment Activo**

- **Location: `"Employee"`** ‚Üí Status: `"Delivered"`
- **Location: `"FP warehouse"`** ‚Üí Status: `"Available"`
- **Location: `"Our office"`** ‚Üí Status: `"Available"`

#### **Con Shipment Activo (Sincronizaci√≥n Obligatoria)**

| Shipment Status            | Product Status                |
| -------------------------- | ----------------------------- |
| `"On Hold - Missing Data"` | `"In Transit - Missing Data"` |
| `"In Preparation"`         | `"In Transit"`                |
| `"On The Way"`             | `"In Transit"`                |
| `"Received"`               | Seg√∫n location final          |
| `"Cancelled"`              | Seg√∫n location final          |

### **Implementaci√≥n Obligatoria**

```typescript
// SIEMPRE calcular status basado en shipment + location
const status = await this.productsService.determineProductStatus(
  {
    fp_shipment: product.fp_shipment,
    location: product.location,
    activeShipment: product.activeShipment,
  },
  tenantName,
);
```

---

## ÔøΩüîÑ Acciones de Movimiento de Productos

### **Acciones V√°lidas**

- **`assign`**: Asignar producto disponible a member
- **`reassign`**: Cambiar asignaci√≥n de producto (member ‚Üí warehouse/office)
- **`return`**: Devolver producto de member a warehouse u office
- **`relocate`**: Mover producto desde member a otro member
- **`offboarding`**: Procesar productos de member que se va se pueden enviar a otro member, office o warehouse

### **Requerimientos OBLIGATORIOS**

#### **1. Preservar `lastAssigned`**

```typescript
// SIEMPRE usar LastAssignedHelper para calcular lastAssigned
const calculatedLastAssigned =
  this.lastAssignedHelper.calculateForProductUpdate(
    product,
    newLocation,
    actionType,
  );
```

#### **2. Sincronizaci√≥n Global**

```typescript
// SIEMPRE sincronizar a global collection despu√©s de cambios
await this.globalProductSyncService.syncProduct({
  tenantId: tenantName,
  originalProductId: product._id,
  sourceCollection: 'products' | 'members',
  // ... otros campos
});
```

#### **3. Transacciones MongoDB**

```typescript
// SIEMPRE usar transacciones para operaciones cr√≠ticas
const session = await connection.startSession();
session.startTransaction();
try {
  // ... operaciones
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
  throw error;
} finally {
  session.endSession();
}
```

#### **4. Validaciones de Estado**

- **activeShipment**: No permitir cambios si producto tiene shipment activo
- **Warehouse assignment**: Asignar warehouse autom√°ticamente para `location: "FP warehouse"`
- **Member validation**: Verificar que member existe antes de asignar

#### **5. Evitar Duplicados**

- **Una sola sincronizaci√≥n por flujo**: Usar flag `_alreadySyncedToGlobal`
- **Consistent IDs**: Usar mismo `_id` para `originalProductId` en global collection

---

## üõ†Ô∏è Reglas de Desarrollo

### **Gesti√≥n de Dependencias**

- ‚úÖ **SIEMPRE** usar package managers: `npm install`, `yarn add`, etc.
- ‚ùå **NUNCA** editar manualmente: `package.json`, `requirements.txt`, etc.

### **Edici√≥n de Archivos**

- ‚úÖ **Archivos existentes**: Usar `str-replace-editor`
- ‚úÖ **Archivos nuevos**: Usar `save-file`
- ‚ùå **NUNCA** sobrescribir archivos existentes con `save-file`

### **Validaciones**

- ‚úÖ **Nuevos endpoints**: Usar Zod schemas
- ‚úÖ **DTOs**: Convertir de class-validator a Zod cuando sea necesario
- ‚úÖ **Validaci√≥n condicional**: `name` requerido solo para category "Merchandising"

### **Logging y Debugging**

- ‚úÖ **Logs estructurados**: Incluir contexto (tenantName, productId, etc.)
- ‚úÖ **Prefijos claros**: `[ServiceName]`, `üîÑ`, `‚úÖ`, `‚ùå`
- ‚úÖ **Debug logs**: Para troubleshooting de bugs complejos

---

## üêõ Bugs Conocidos y Soluciones

### **1. Duplicados en Global Collection**

**Causa**: M√∫ltiples sincronizaciones del mismo producto
**Soluci√≥n**: Flag `_alreadySyncedToGlobal` + skip resync para reassign/return

### **2. lastAssigned Vac√≠o**

**Causa**: No preservar ubicaci√≥n anterior al mover productos
**Soluci√≥n**: Usar `LastAssignedHelper.calculateForProductUpdate()`

### **3. originalProductId null**

**Causa**: Sincronizar antes de que el producto tenga `_id`
**Soluci√≥n**: Sincronizar DESPU√âS de `member.save()`

### **4. CSV con FP warehouse**

**Causa**: Templates viejos permiten ubicaci√≥n no v√°lida
**Soluci√≥n**: Validaci√≥n Zod que rechaza arrays con `location: "FP warehouse"`

---

## üìã Checklist para Nuevas Features

### **Antes de Implementar**

- [ ] **Modularizaci√≥n**: ¬øEncaja en carpeta/servicio existente?
- [ ] **Servicios**: Identificar ra√≠z vs transversales involucrados
- [ ] **TenantModelRegistry**: ¬øRequiere nuevos modelos por tenant?
- [ ] **Transacciones**: ¬øOperaciones cr√≠ticas que requieren atomicidad?
- [ ] **Sincronizaci√≥n**: Planificar sync a global collection
- [ ] **Estados**: Considerar impacto en status de productos/shipments
- [ ] **lastAssigned**: Evaluar cambios en ubicaciones

### **Durante Implementaci√≥n**

- [ ] **Dependencias**: Usar package managers (npm, yarn)
- [ ] **Validaciones**: Implementar schemas Zod
- [ ] **Logs**: Agregar logs estructurados con contexto
- [ ] **Errores**: Manejar excepciones apropiadamente
- [ ] **Estados**: Respetar reglas SAGRADAS de status
- [ ] **Modularidad**: Seguir patr√≥n de servicios establecido

### **Despu√©s de Implementar**

- [ ] **Movimientos**: Probar flujos de productos (assign/reassign/return)
- [ ] **Sincronizaci√≥n**: Verificar sync a global collection
- [ ] **Duplicados**: Confirmar que no hay duplicados
- [ ] **Estados**: Validar status correcto seg√∫n shipment/location
- [ ] **lastAssigned**: Verificar preservaci√≥n de ubicaciones
- [ ] **Transacciones**: Confirmar atomicidad de operaciones cr√≠ticas

---

## üéØ Principios Clave

1. **Modularizaci√≥n**: Reutilizar servicios existentes antes de crear nuevos
2. **Estados SAGRADOS**: Status de productos SIEMPRE sincronizado con shipments
3. **Consistencia**: Mismo patr√≥n para operaciones similares
4. **Transaccionalidad**: Operaciones at√≥micas para integridad de datos
5. **Observabilidad**: Logs claros para debugging
6. **Escalabilidad**: Servicios desacoplados y reutilizables
7. **Confiabilidad**: Validaciones exhaustivas y manejo de errores
8. **TenantModelRegistry**: Gesti√≥n centralizada de modelos multi-tenant

---

## üö® Reglas SAGRADAS (NUNCA ROMPER)

### **1. Estados de Productos**

- ‚úÖ **Sin shipment + Employee** = `"Delivered"`
- ‚úÖ **Sin shipment + Warehouse/Office** = `"Available"`
- ‚úÖ **Con shipment** = Status sincronizado con shipment status

### **2. Sincronizaci√≥n Global**

- ‚úÖ **Siempre** sincronizar cambios a `global_products`
- ‚úÖ **Una sola** sincronizaci√≥n por flujo (evitar duplicados)
- ‚úÖ **Consistent IDs** entre collections locales y global

### **3. Transacciones**

- ‚úÖ **Operaciones cr√≠ticas** SIEMPRE en transacciones
- ‚úÖ **Rollback** autom√°tico en caso de error
- ‚úÖ **Atomicidad** para movimientos de productos

### **4. lastAssigned**

- ‚úÖ **Preservar** ubicaci√≥n anterior al mover productos
- ‚úÖ **Usar** `LastAssignedHelper` para c√°lculos
- ‚úÖ **Formato** correcto: email para Employee, "FP warehouse - {country}" para warehouse
