# Augment Agent - ConfiguraciÃ³n del Proyecto FirstPlug

## ğŸ—ï¸ Arquitectura del Sistema

### **PatrÃ³n de Servicios por Capas**

#### **Servicios RaÃ­z (Root Services)**

InteractÃºan directamente con la base de datos, manejan CRUD bÃ¡sico:

- **`ProductsService`**: GestiÃ³n de productos en collections locales
- **`MembersService`**: GestiÃ³n de members y productos embebidos
- **`ShipmentsService`**: GestiÃ³n de shipments y logistics
- **`TenantsService`**: GestiÃ³n de tenants y configuraciÃ³n
- **`WarehousesService`**: GestiÃ³n de warehouses y asignaciones

#### **Servicios Transversales (Cross-cutting Services)**

Coordinan entre servicios raÃ­z, manejan lÃ³gica de negocio compleja:

- **`AssignmentsService`**: Movimiento de productos entre collections
- **`LogisticsService`**: CoordinaciÃ³n de shipments y actualizaciones
- **`GlobalProductSyncService`**: SincronizaciÃ³n a collection global
- **`WarehouseAssignmentService`**: AsignaciÃ³n inteligente de warehouses
- **`ShipmentOfficeCoordinatorService`**: CoordinaciÃ³n entre shipments y oficinas

#### **Servicios Helper**

LÃ³gica de negocio especÃ­fica y reutilizable:

- **`LastAssignedHelper`**: CÃ¡lculo de lastAssigned preservando ubicaciones
- **`SlackService`**: Notificaciones y alertas
- **`HistoryService`**: Tracking de cambios y auditorÃ­a

#### **Servicios de Infraestructura**

- **`SuperAdminService`**: Operaciones cross-tenant, gestiÃ³n global
- **`AuthService`**: AutenticaciÃ³n y autorizaciÃ³n
- **`ConfigService`**: ConfiguraciÃ³n de aplicaciÃ³n
- **`TenantModelRegistry`**: Registry de modelos por tenant (CLAVE)
- **`TenantConnectionService`**: GestiÃ³n de conexiones multi-tenant

#### **ğŸš¨ PATRÃ“N DE COORDINACIÃ“N (REGLA SAGRADA)**

**REGLA FUNDAMENTAL**: Los servicios raÃ­z NUNCA deben depender directamente de otros servicios raÃ­z.

**PROBLEMA COMÃšN**: Inyectar un servicio raÃ­z en otro servicio raÃ­z crea acoplamiento fuerte.

**SOLUCIÃ“N OBLIGATORIA**: Crear servicios transversales coordinadores.

---

### **ğŸ“Š Diagrama de Arquitectura Correcta**

```
SERVICIOS RAÃZ (Root Services)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProductsService â”‚    â”‚ MembersService  â”‚    â”‚ ShipmentsServiceâ”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ - CRUD productosâ”‚    â”‚ - CRUD members  â”‚    â”‚ - CRUD shipmentsâ”‚
â”‚ - Solo DB ops   â”‚    â”‚ - Solo DB ops   â”‚    â”‚ - Solo DB ops   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TenantsService  â”‚    â”‚WarehousesServiceâ”‚    â”‚ OfficesService  â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ - CRUD tenants  â”‚    â”‚ - CRUD warehouseâ”‚    â”‚ - CRUD offices  â”‚
â”‚ - Solo DB ops   â”‚    â”‚ - Solo DB ops   â”‚    â”‚ - Solo DB ops   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â–²
                              â”‚
                    NO DEPENDENCIES ENTRE ELLOS
                              â”‚
                              â–¼

SERVICIOS TRANSVERSALES (Cross-cutting Services)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COORDINADORES                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AssignmentsService          â”‚ LogisticsService                  â”‚
â”‚ - Coordina Products+Members â”‚ - Coordina Shipments+Products     â”‚
â”‚                             â”‚                                   â”‚
â”‚ GlobalProductSyncService    â”‚ ShipmentOfficeCoordinatorService  â”‚
â”‚ - Coordina sync global      â”‚ - Coordina Shipments+Offices      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **âœ… PATRONES CORRECTOS**

#### **1. Coordinador Simple**

```typescript
// âœ… CORRECTO: Servicio transversal coordina entre servicios raÃ­z
@Injectable()
export class ShipmentOfficeCoordinatorService {
  constructor(private readonly officesService: OfficesService) {}

  async handleShipmentStatusChange(
    originOfficeId: Types.ObjectId | null,
    destinationOfficeId: Types.ObjectId | null,
    oldStatus: string,
    newStatus: string,
    tenantName: string,
  ): Promise<void> {
    // LÃ³gica de coordinaciÃ³n
    await this.officesService.updateActiveShipmentsFlagsForShipment(
      originOfficeId,
      destinationOfficeId,
      tenantName,
    );
  }
}

// âœ… CORRECTO: Servicio raÃ­z usa coordinador
@Injectable()
export class ShipmentsService {
  constructor(private readonly coordinator: ShipmentOfficeCoordinatorService) {}

  async updateShipment() {
    // ... lÃ³gica de shipment

    // Delegar coordinaciÃ³n al servicio transversal
    await this.coordinator.handleShipmentStatusChange(
      originOfficeId,
      destinationOfficeId,
      oldStatus,
      newStatus,
      tenantName,
    );
  }
}
```

#### **2. Coordinador Complejo (MÃºltiples Servicios)**

```typescript
// âœ… CORRECTO: Coordinador que maneja mÃºltiples servicios raÃ­z
@Injectable()
export class AssignmentsService {
  constructor(
    private readonly productsService: ProductsService,
    private readonly membersService: MembersService,
    private readonly globalProductSyncService: GlobalProductSyncService,
  ) {}

  async moveProductFromMemberToWarehouse() {
    // Coordina entre mÃºltiples servicios raÃ­z
    const product = await this.productsService.create();
    await this.membersService.removeProduct();
    await this.globalProductSyncService.sync();
  }
}
```

---

### **âŒ ANTI-PATRONES (NUNCA HACER)**

#### **1. Dependencia Directa Entre Servicios RaÃ­z**

```typescript
// âŒ MAL: Servicio raÃ­z dependiendo de otro servicio raÃ­z
@Injectable()
export class ShipmentsService {
  constructor(
    private readonly officesService: OfficesService, // âŒ ACOPLAMIENTO
  ) {}

  async updateShipment() {
    // âŒ Llamada directa entre servicios raÃ­z
    await this.officesService.updateFlags();
  }
}
```

#### **2. LÃ³gica de CoordinaciÃ³n en Servicio RaÃ­z**

```typescript
// âŒ MAL: LÃ³gica de coordinaciÃ³n mezclada con CRUD
@Injectable()
export class ProductsService {
  constructor(
    private readonly membersService: MembersService, // âŒ ACOPLAMIENTO
    private readonly shipmentsService: ShipmentsService, // âŒ ACOPLAMIENTO
  ) {}

  async updateProduct() {
    // âŒ Responsabilidad mezclada
    await this.save(); // CRUD (correcto)
    await this.membersService.updateFlags(); // âŒ CoordinaciÃ³n (incorrecto)
    await this.shipmentsService.updateStatus(); // âŒ CoordinaciÃ³n (incorrecto)
  }
}
```

---

### **ğŸ”§ CÃ“MO REFACTORIZAR ACOPLAMIENTO**

#### **Paso 1: Identificar el Problema**

```typescript
// ğŸš¨ DETECTAR: Â¿Hay servicios raÃ­z inyectados en otros servicios raÃ­z?
class ServiceA {
  constructor(private serviceB: ServiceB) {} // ğŸš¨ PROBLEMA
}
```

#### **Paso 2: Crear Coordinador**

```typescript
// âœ… CREAR: Servicio transversal coordinador
@Injectable()
export class ServiceABCoordinatorService {
  constructor(
    private readonly serviceA: ServiceA,
    private readonly serviceB: ServiceB,
  ) {}

  async coordinateOperation() {
    await this.serviceA.doSomething();
    await this.serviceB.doSomethingElse();
  }
}
```

#### **Paso 3: Refactorizar Dependencias**

```typescript
// âœ… REFACTORIZAR: Usar coordinador en lugar de dependencia directa
class ServiceA {
  constructor(
    private readonly coordinator: ServiceABCoordinatorService, // âœ… CORRECTO
  ) {}

  async operation() {
    await this.coordinator.coordinateOperation();
  }
}
```

#### **Paso 4: Actualizar MÃ³dulos**

```typescript
// âœ… AGREGAR: Coordinador a mÃ³dulos relevantes
@Module({
  providers: [
    ServiceA,
    ServiceB,
    ServiceABCoordinatorService, // âœ… AGREGAR
  ],
})
export class SomeModule {}
```

---

### **ğŸ“‹ CHECKLIST DE VALIDACIÃ“N**

**Antes de crear/modificar servicios:**

- [ ] **Â¿Es un servicio raÃ­z?** â†’ Solo debe hacer CRUD de su entidad
- [ ] **Â¿Necesita otro servicio raÃ­z?** â†’ Crear coordinador transversal
- [ ] **Â¿Es lÃ³gica de coordinaciÃ³n?** â†’ Debe ir en servicio transversal
- [ ] **Â¿Hay dependencias circulares?** â†’ Usar coordinadores para romperlas

**Al revisar cÃ³digo existente:**

- [ ] **Â¿Servicios raÃ­z inyectan otros servicios raÃ­z?** â†’ Refactorizar con coordinador
- [ ] **Â¿LÃ³gica de negocio compleja en servicios raÃ­z?** â†’ Mover a transversal
- [ ] **Â¿MÃºltiples responsabilidades en un servicio?** â†’ Separar en coordinadores

---

### **ğŸ¯ EJEMPLOS REALES DEL PROYECTO**

#### **âœ… CORRECTO: ShipmentOfficeCoordinatorService**

```
ShipmentsService â†’ ShipmentOfficeCoordinatorService â†’ OfficesService
LogisticsService â†’ ShipmentOfficeCoordinatorService â†’ OfficesService
```

#### **âœ… CORRECTO: AssignmentsService**

```
Controller â†’ AssignmentsService â†’ ProductsService + MembersService + GlobalSync
```

#### **âœ… CORRECTO: LogisticsService**

```
Controller â†’ LogisticsService â†’ ShipmentsService + ProductsService + MembersService
```

#### **âŒ INCORRECTO (Ejemplo de lo que NO hacer)**

```
ShipmentsService â†’ OfficesService (ACOPLAMIENTO DIRECTO)
ProductsService â†’ MembersService (ACOPLAMIENTO DIRECTO)
```

#### **Servicios Comunes**

- **`CommonService`**: Utilidades compartidas
- **`ValidationService`**: Validaciones reutilizables
- **`InfraService`**: Servicios de infraestructura base

---

## ğŸ¢ Multi-Tenant Architecture

### **Estructura de Base de Datos**

- **Tenant Database**: `tenant_{tenantName}` (ej: `tenant_mechi_test`)
  - Collections: `products`, `members`, `shipments`, `offices`, `teams`, `historial`, `shipmentsMetadata`
- **Global Database**: `firstPlug`
  - Collections: `tenants`, `users`, `global_products`, `warehouses`

### **Roles y Permisos**

- **SuperAdmin**: Acceso a todos los tenants, puede crear/modificar cualquier dato
- **Tenant User**: Solo acceso a su tenant especÃ­fico
- **admin**: Solo acceso a su tenant especÃ­fico

### **Tenant Resolution**

```typescript
// Siempre resolver tenant por tenantName
const connection = await this.connectionService.getTenantConnection(tenantName);
const ProductModel = connection.model('Product', ProductSchema);
```

---

## ğŸ“¦ Ubicaciones de Productos

### **Ubicaciones VÃ¡lidas**

- **`"Employee"`**: Producto asignado a un member (en `members` collection)
- **`"FP warehouse"`**: Producto en warehouse de FirstPlug (en `products` collection)
- **`"Our office"`**: Producto en oficina del tenant (en `products` collection)

### **Collections por UbicaciÃ³n**

- **Employee** â†’ `members.products[]` (embebido)
- **FP warehouse** â†’ `products` collection + `fpWarehouse` data
- **Our office** â†’ `products` collection + office data

---

## ï¿½ Estados de Productos (SAGRADO)

### **Regla Fundamental: Estado = f(Location, Shipment)**

#### **Sin Shipment Activo**

- **Location: `"Employee"`** â†’ Status: `"Delivered"`
- **Location: `"FP warehouse"`** â†’ Status: `"Available"`
- **Location: `"Our office"`** â†’ Status: `"Available"`

#### **Con Shipment Activo (SincronizaciÃ³n Obligatoria)**

| Shipment Status            | Product Status                |
| -------------------------- | ----------------------------- |
| `"On Hold - Missing Data"` | `"In Transit - Missing Data"` |
| `"In Preparation"`         | `"In Transit"`                |
| `"On The Way"`             | `"In Transit"`                |
| `"Received"`               | SegÃºn location final          |
| `"Cancelled"`              | SegÃºn location final          |

### **ImplementaciÃ³n Obligatoria**

```typescript
// SIEMPRE calcular status basado en shipment + location
const status = await this.productsService.determineProductStatus(
  {
    fp_shipment: product.fp_shipment,
    location: product.location,
    activeShipment: product.activeShipment,
  },
  tenantName,
);
```

---

## ï¿½ğŸ”„ Acciones de Movimiento de Productos

### **Acciones VÃ¡lidas**

- **`assign`**: Asignar producto disponible a member
- **`reassign`**: Cambiar asignaciÃ³n de producto (member â†’ warehouse/office)
- **`return`**: Devolver producto de member a warehouse u office
- **`relocate`**: Mover producto desde member a otro member
- **`offboarding`**: Procesar productos de member que se va se pueden enviar a otro member, office o warehouse

### **Requerimientos OBLIGATORIOS**

#### **1. Preservar `lastAssigned`**

```typescript
// SIEMPRE usar LastAssignedHelper para calcular lastAssigned
const calculatedLastAssigned =
  this.lastAssignedHelper.calculateForProductUpdate(
    product,
    newLocation,
    actionType,
  );
```

#### **2. SincronizaciÃ³n Global**

```typescript
// SIEMPRE sincronizar a global collection despuÃ©s de cambios
await this.globalProductSyncService.syncProduct({
  tenantId: tenantName,
  originalProductId: product._id,
  sourceCollection: 'products' | 'members',
  // ... otros campos
});
```

#### **3. Transacciones MongoDB**

```typescript
// SIEMPRE usar transacciones para operaciones crÃ­ticas
const session = await connection.startSession();
session.startTransaction();
try {
  // ... operaciones
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
  throw error;
} finally {
  session.endSession();
}
```

#### **4. Validaciones de Estado**

- **activeShipment**: No permitir cambios si producto tiene shipment activo
- **Warehouse assignment**: Asignar warehouse automÃ¡ticamente para `location: "FP warehouse"`
- **Member validation**: Verificar que member existe antes de asignar

#### **5. Evitar Duplicados**

- **Una sola sincronizaciÃ³n por flujo**: Usar flag `_alreadySyncedToGlobal`
- **Consistent IDs**: Usar mismo `_id` para `originalProductId` en global collection

---

## ğŸ› ï¸ Reglas de Desarrollo

### **GestiÃ³n de Dependencias**

- âœ… **SIEMPRE** usar package managers: `npm install`, `yarn add`, etc.
- âŒ **NUNCA** editar manualmente: `package.json`, `requirements.txt`, etc.

### **EdiciÃ³n de Archivos**

- âœ… **Archivos existentes**: Usar `str-replace-editor`
- âœ… **Archivos nuevos**: Usar `save-file`
- âŒ **NUNCA** sobrescribir archivos existentes con `save-file`

### **Validaciones**

- âœ… **Nuevos endpoints**: Usar Zod schemas
- âœ… **DTOs**: Convertir de class-validator a Zod cuando sea necesario
- âœ… **ValidaciÃ³n condicional**: `name` requerido solo para category "Merchandising"

### **Logging y Debugging**

- âœ… **Logs estructurados**: Incluir contexto (tenantName, productId, etc.)
- âœ… **Prefijos claros**: `[ServiceName]`, `ğŸ”„`, `âœ…`, `âŒ`
- âœ… **Debug logs**: Para troubleshooting de bugs complejos

---

## ğŸ› Bugs Conocidos y Soluciones

### **1. Acoplamiento de Servicios (CRÃTICO)**

**Causa**: Inyectar servicios raÃ­z en otros servicios raÃ­z
**SÃ­ntomas**:

- Dependencias circulares
- CÃ³digo difÃ­cil de testear
- ViolaciÃ³n de responsabilidad Ãºnica
  **SoluciÃ³n**: Crear servicio coordinador transversal
  **Ejemplo**: `ShipmentOfficeCoordinatorService` para `ShipmentsService` â†” `OfficesService`

### **2. Duplicados en Global Collection**

**Causa**: MÃºltiples sincronizaciones del mismo producto
**SoluciÃ³n**: Flag `_alreadySyncedToGlobal` + skip resync para reassign/return

### **3. lastAssigned VacÃ­o**

**Causa**: No preservar ubicaciÃ³n anterior al mover productos
**SoluciÃ³n**: Usar `LastAssignedHelper.calculateForProductUpdate()`

### **4. originalProductId null**

**Causa**: Sincronizar antes de que el producto tenga `_id`
**SoluciÃ³n**: Sincronizar DESPUÃ‰S de `member.save()`

### **5. CSV con FP warehouse**

**Causa**: Templates viejos permiten ubicaciÃ³n no vÃ¡lida
**SoluciÃ³n**: ValidaciÃ³n Zod que rechaza arrays con `location: "FP warehouse"`

### **6. Eventos Innecesarios**

**Causa**: Usar eventos complejos para coordinaciÃ³n simple
**SÃ­ntomas**:

- Listeners complejos
- CÃ³digo difÃ­cil de seguir
- Debugging complicado
  **SoluciÃ³n**: Llamadas directas a travÃ©s de coordinadores

---

## ğŸ“‹ Checklist para Nuevas Features

### **Antes de Implementar**

- [ ] **ğŸ—ï¸ ARQUITECTURA**: Â¿Respeta el patrÃ³n de servicios por capas?
- [ ] **ğŸš¨ ACOPLAMIENTO**: Â¿Evita dependencias directas entre servicios raÃ­z?
- [ ] **ğŸ”„ COORDINACIÃ“N**: Â¿Necesita coordinador transversal?
- [ ] **ModularizaciÃ³n**: Â¿Encaja en carpeta/servicio existente?
- [ ] **Servicios**: Identificar raÃ­z vs transversales involucrados
- [ ] **TenantModelRegistry**: Â¿Requiere nuevos modelos por tenant?
- [ ] **Transacciones**: Â¿Operaciones crÃ­ticas que requieren atomicidad?
- [ ] **SincronizaciÃ³n**: Planificar sync a global collection
- [ ] **Estados**: Considerar impacto en status de productos/shipments
- [ ] **lastAssigned**: Evaluar cambios en ubicaciones

### **Durante ImplementaciÃ³n**

- [ ] **ğŸ—ï¸ SERVICIOS**: Â¿Es servicio raÃ­z o transversal?
- [ ] **ğŸš¨ INYECCIÃ“N**: Â¿Solo inyecta servicios de su capa o inferiores?
- [ ] **ğŸ”„ COORDINADORES**: Â¿Usa coordinadores para comunicaciÃ³n entre servicios raÃ­z?
- [ ] **Dependencias**: Usar package managers (npm, yarn)
- [ ] **Validaciones**: Implementar schemas Zod
- [ ] **Logs**: Agregar logs estructurados con contexto
- [ ] **Errores**: Manejar excepciones apropiadamente
- [ ] **Estados**: Respetar reglas SAGRADAS de status
- [ ] **Modularidad**: Seguir patrÃ³n de servicios establecido

### **DespuÃ©s de Implementar**

- [ ] **ğŸ—ï¸ ARQUITECTURA**: Â¿Respeta todas las reglas de servicios por capas?
- [ ] **ğŸš¨ ACOPLAMIENTO**: Â¿No hay dependencias directas entre servicios raÃ­z?
- [ ] **ğŸ”„ COORDINACIÃ“N**: Â¿Los coordinadores funcionan correctamente?
- [ ] **Movimientos**: Probar flujos de productos (assign/reassign/return)
- [ ] **SincronizaciÃ³n**: Verificar sync a global collection
- [ ] **Duplicados**: Confirmar que no hay duplicados
- [ ] **Estados**: Validar status correcto segÃºn shipment/location
- [ ] **lastAssigned**: Verificar preservaciÃ³n de ubicaciones
- [ ] **Transacciones**: Confirmar atomicidad de operaciones crÃ­ticas

---

## ğŸ¯ Principios Clave

1. **ModularizaciÃ³n**: Reutilizar servicios existentes antes de crear nuevos
2. **Estados SAGRADOS**: Status de productos SIEMPRE sincronizado con shipments
3. **Consistencia**: Mismo patrÃ³n para operaciones similares
4. **Transaccionalidad**: Operaciones atÃ³micas para integridad de datos
5. **Observabilidad**: Logs claros para debugging
6. **Escalabilidad**: Servicios desacoplados y reutilizables
7. **Confiabilidad**: Validaciones exhaustivas y manejo de errores
8. **TenantModelRegistry**: GestiÃ³n centralizada de modelos multi-tenant

---

## ğŸš¨ Reglas SAGRADAS (NUNCA ROMPER)

### **1. Arquitectura de Servicios (CRÃTICO)**

- âœ… **Servicios raÃ­z** NUNCA dependen de otros servicios raÃ­z
- âœ… **Usar coordinadores** para comunicaciÃ³n entre servicios raÃ­z
- âœ… **Responsabilidad Ãºnica** por servicio
- âŒ **PROHIBIDO**: `ShipmentsService` â†’ `OfficesService` (directo)
- âœ… **CORRECTO**: `ShipmentsService` â†’ `Coordinator` â†’ `OfficesService`

### **2. Estados de Productos**

- âœ… **Sin shipment + Employee** = `"Delivered"`
- âœ… **Sin shipment + Warehouse/Office** = `"Available"`
- âœ… **Con shipment** = Status sincronizado con shipment status

### **3. SincronizaciÃ³n Global**

- âœ… **Siempre** sincronizar cambios a `global_products`
- âœ… **Una sola** sincronizaciÃ³n por flujo (evitar duplicados)
- âœ… **Consistent IDs** entre collections locales y global

### **4. Transacciones**

- âœ… **Operaciones crÃ­ticas** SIEMPRE en transacciones
- âœ… **Rollback** automÃ¡tico en caso de error
- âœ… **Atomicidad** para movimientos de productos

### **5. lastAssigned**

- âœ… **Preservar** ubicaciÃ³n anterior al mover productos
- âœ… **Usar** `LastAssignedHelper` para cÃ¡lculos
- âœ… **Formato** correcto: email para Employee, "FP warehouse - {country}" para warehouse

### **6. CoordinaciÃ³n de Servicios**

- âœ… **Crear coordinador** cuando se necesite comunicaciÃ³n entre servicios raÃ­z
- âœ… **Inyectar coordinador** en servicios que lo necesiten
- âœ… **Documentar** nuevos coordinadores en este archivo
- âŒ **PROHIBIDO**: Eventos complejos para coordinaciÃ³n simple
- âŒ **PROHIBIDO**: LÃ³gica de coordinaciÃ³n en servicios raÃ­z
